<%= javascript_include_tag "stream" %>

<div id="ajax-modal" class="modal hide fade" tabindex="-1"></div>
<div id="match-modal" class="modal hide fade" tabindex="-1"></div>

<h1 id="stream-name"><%= @stream.name %></h1>

<% if @stream_owner.user_id === current_user.id || @collaborator.present? %>
  <div class="breadcrumb" style="margin: 0">
    <%= link_to_modal 'Admin', user_stream_path(@stream), 'data-width' => "950", 'data-height' =>"600", 'data-title' => "Stream Admin", :remote => true, :class => 'btn' %>

    <% if @stream.match.blank? %>
      <%= link_to_modal t('.new_match'), new_polymorphic_path([@stream, Match.new]),
            remote: true, data: {'modal-target' => '#match-modal'},
            :id => 'manage-match', :class => 'btn' %>
    <% else %>
      <%= link_to_modal t('.manage_match'), polymorphic_path([@stream, @stream.match]),
            remote: true, data: {'modal-target' => '#match-modal', 'match-id' => @stream.match._id.to_s},
            :id => 'manage-match', :class => 'btn' %>
    <% end %>
  </div>
<% end %>

<div class="container-fluid">
  <div class="row-fluid">
    <div class="span6">
      <ul class="thumbnails">
        <li>
          <%= link_to image_tag(@stream.thumbnail.url(:thumb), id: 'stream-thumbnail'), '#', :class => 'thumbnail' %>
        </li>
      </ul>

      <fieldset>
        <legend>Details</legend>

        <div id="stream-details" class="well">
          <%= @stream.details %>
        </div>
      </fieldset>

      <form id="chatbox-form">
        <fieldset>
          <legend>Chat</legend>

          <pre id="chatbox" class="pre-scrollable"></pre>

          <div class="form-inline">
            <input type="text" placeholder="Say anything..." />
            <button type="submit" class="btn">Send</button>
          </div>
        </fieldset>
      </form>
    </div>

    <div class="span6">
      <h4 id="stream-match-details">
        <% if @stream.match %>
          <%= match_details(@stream.match) %>
        <% end %>
      </h4>
      <div id="stream-bet-container" class="thumbnail" style="<%= @stream.match.try(:betting) ? '' : 'display: none' %>">
        <div class="caption">
          <%= link_to_modal 'Propose a Bet', @stream.match ? new_match_bet_path(@stream.match) : '#', 
                :remote => true, :class => 'btn', style: 'width: 95%', :id => 'propose-bet' %>
        </div>
        <div id="bet-container" class="caption">
          <% unless @bets.empty? %>
            <% @bets.each do |b| %>
              <div id="<%= b._id %>" class="well well-small bet" title="Bet Details" data-content="<%= bet_tooltip(b).html_safe %>" data-match-id="<%= b.match._id %>">
                <%= "#{b.bookie.try(:username)}: #{b.winner.try(:display_name)}>#{b.loser.try(:display_name)} #{b.amount} Points #{b.odds}" %>
                <div class="pull-right">
                  <% if b.bettor %>
                    Accepted: <%= b.bettor.try(:username) %>
                  <% else %>
                    <% if b.bookie.try(:id) === current_user.id %>
                      <%= link_to "Cancel", match_bet_path(b.match, b),
                            'method' => 'delete', 'data-remote' => 'true', 'data-type' => :json,
                            :data => { :confirm => t('.confirm', :default => t("helpers.links.confirm", :default => 'Are you sure?')) } %>
                    <% else %>
                      <%= link_to "Accept", match_bet_path(b.match, b),
                            'method' => 'put', 'data-remote' => 'true', 'data-type' => :json,
                            :data => { :confirm => t('.confirm', :default => t("helpers.links.confirm", :default => 'Are you sure?')) } %>
                    <% end %>
                  <% end %>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<%= javascript_tag do %>
  $(function () {
    if (PointGaming.authToken) {
      PointGaming.socket = io.connect(PointGaming.socketio_uri);
      PointGaming.socket.on("ready", function(){
        // send auth request
        PointGaming.socket.emit("auth", {auth_token: PointGaming.authToken});
      });

      // register listener for auth callback
      PointGaming.socket.on("auth_resp", function(data){
        if (data.success === true && data.user) {
          PointGaming.user = data.user;
        }
      });

      <% if @stream_owner.user_id === current_user.id || @collaborator.present? %>
        new PointGaming.StreamAdminController();
        new PointGaming.MatchAdminController(<%= @stream.match ? @stream.match.to_json.html_safe : '{}' %>, {
          new_match_path: "<%= new_stream_match_path(@stream, Match.new) %>",
          polymorphic_match_path: "<%= stream_match_path(@stream, ':match_id') %>",
          match_path: "<%= match_path(':match_id') %>"
        });
      <% end %>

      new PointGaming.BetsController({
        chat_room: "s.<%="#{@stream._id}"%>"
      });

      new PointGaming.StreamsController({
        chat_room: "s.<%="#{@stream._id}"%>"
      });

      new PointGaming.MatchController(
        <%= @stream.match ? @stream.match.to_json.html_safe : '{}' %>,
        "<%= new_match_bet_path(':match_id') %>"
      );

      var chat_room = new PointGaming.chatbox({
        message_window_selector: "#chatbox",
        chat_room: "s.<%="#{@stream._id}"%>"
      }, PointGaming.socket);

      $("#chatbox-form").submit(function(e){
        var inputbox = $('input[type="text"]', this);
        var message = inputbox.val();
        if (message) chat_room.sendMessage(message);
        e.preventDefault();
        inputbox.val('');
      });
    }
  });
<% end %>
